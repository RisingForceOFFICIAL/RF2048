<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>RF2048</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--accent:#0ea5e9;--accent2:#67e8f9;--bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--text:#e5e5e5;--text2:#a3a3a3;--cell:#262626;--radius:12px}
.light{--bg:#f5f5f5;--bg2:#e5e5e5;--bg3:#d4d4d4;--text:#171717;--text2:#525252;--cell:#d4d4d4}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100dvh;overflow:hidden;transition:background .3s,color .3s;-webkit-user-select:none;user-select:none}
.header{display:flex;align-items:center;justify-content:space-between;width:min(480px,92vw);margin-bottom:12px}
.logo{font-size:2.4rem;font-weight:900;letter-spacing:-1px}
.logo span{color:var(--accent)}
.scores{display:flex;gap:8px}
.score-box{background:var(--bg3);border-radius:8px;padding:6px 16px;text-align:center;min-width:80px}
.score-box .label{font-size:.65rem;color:var(--accent2);text-transform:uppercase;letter-spacing:1px}
.score-box .val{font-size:1.3rem;font-weight:700}
.controls{display:flex;align-items:center;justify-content:space-between;width:min(480px,92vw);margin-bottom:12px;gap:8px}
.btn{background:var(--bg3);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:8px 18px;font-size:.85rem;font-weight:600;cursor:pointer;transition:background .2s,transform .1s}
.btn:hover{background:var(--accent);color:#fff}
.btn:active{transform:scale(.95)}
.board-wrap{position:relative;width:min(480px,92vw);aspect-ratio:1;background:var(--bg2);border-radius:var(--radius);padding:min(12px,2.5vw);transition:background .3s}
.board{position:relative;width:100%;height:100%;display:grid;grid-template:repeat(4,1fr)/repeat(4,1fr);gap:min(12px,2.5vw)}
.cell{background:var(--cell);border-radius:var(--radius);transition:background .3s}
.tile{position:absolute;display:flex;align-items:center;justify-content:center;font-weight:800;border-radius:var(--radius);transition:top .15s ease,left .15s ease;z-index:2}
.tile.merged{animation:pop .25s ease}
.tile.new{animation:appear .2s ease}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.18)}100%{transform:scale(1)}}
@keyframes appear{0%{transform:scale(0);opacity:0}100%{transform:scale(1);opacity:1}}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;opacity:0;pointer-events:none;transition:opacity .3s}
.overlay.show{opacity:1;pointer-events:auto}
.overlay h2{font-size:2rem;margin-bottom:12px}
.overlay .btn{margin-top:8px;font-size:1rem;padding:12px 28px}
.theme-toggle{background:none;border:none;color:var(--text2);cursor:pointer;font-size:1.3rem;padding:4px 8px}
</style>
</head>
<body>
<div class="header">
  <div class="logo"><span>RF</span>2048</div>
  <div class="scores">
    <div class="score-box"><div class="label">Score</div><div class="val" id="score">0</div></div>
    <div class="score-box"><div class="label">Best</div><div class="val" id="best">0</div></div>
  </div>
</div>
<div class="controls">
  <button class="btn" id="btnNew">New Game</button>
  <button class="btn" id="btnUndo">Undo</button>
  <button class="theme-toggle" id="btnTheme" title="Toggle theme">üåô</button>
</div>
<div class="board-wrap" id="boardWrap">
  <div class="board" id="board"></div>
  <div class="overlay" id="overWin"><h2 style="color:var(--accent)">You Win! üéâ</h2><button class="btn" id="btnKeep">Keep Playing</button><button class="btn" id="btnNewW">New Game</button></div>
  <div class="overlay" id="overLose"><h2>Game Over</h2><button class="btn" id="btnNewL">New Game</button></div>
</div>
<script>
(function(){
const COLORS={
  2:['#e8e0d6','#776e65'],4:['#ede0c8','#776e65'],8:['#f2b179','#fff'],
  16:['#f59563','#fff'],32:['#f67c5f','#fff'],64:['#f65e3b','#fff'],
  128:['#edcf72','#fff'],256:['#edcc61','#fff'],512:['#edc850','#fff'],
  1024:['#edc53f','#fff'],2048:['#edc22e','#fff'],4096:['#3c3a32','#fff'],
  8192:['#0ea5e9','#fff'],16384:['#67e8f9','#1a1a1a']
};
function tileColor(v){return COLORS[v]||['#0ea5e9','#fff']}
function tileFontSize(v,sz){
  if(v<100)return sz*.45+'px';if(v<1000)return sz*.36+'px';
  if(v<10000)return sz*.28+'px';return sz*.22+'px';
}

let grid,score,bestScore,prevState,won,keepPlaying;
const $board=document.getElementById('board'),
      $score=document.getElementById('score'),
      $best=document.getElementById('best'),
      $overWin=document.getElementById('overWin'),
      $overLose=document.getElementById('overLose'),
      $wrap=document.getElementById('boardWrap');

// init cells
for(let i=0;i<16;i++){const c=document.createElement('div');c.className='cell';$board.appendChild(c)}

function init(){
  grid=Array.from({length:4},()=>[0,0,0,0]);
  score=0;won=false;keepPlaying=false;prevState=null;
  $overWin.classList.remove('show');$overLose.classList.remove('show');
  bestScore=+(localStorage.getItem('rf2048best')||0);
  spawn();spawn();render();
}

function save(){prevState={grid:grid.map(r=>[...r]),score}}
function undo(){
  if(!prevState)return;
  grid=prevState.grid;score=prevState.score;prevState=null;
  $overWin.classList.remove('show');$overLose.classList.remove('show');
  render();
}

function spawn(){
  const empty=[];
  for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(!grid[r][c])empty.push([r,c]);
  if(!empty.length)return;
  const[r,c]=empty[Math.random()*empty.length|0];
  grid[r][c]=Math.random()<.9?2:4;
}

let tileEls=[];
function render(){
  $score.textContent=score;
  if(score>bestScore){bestScore=score;localStorage.setItem('rf2048best',bestScore)}
  $best.textContent=bestScore;
  // remove old tiles after animation
  const old=tileEls;setTimeout(()=>old.forEach(t=>t.el&&t.el.remove()),160);
  tileEls=[];
  const bw=$board.offsetWidth,gap=parseFloat(getComputedStyle($board).gap)||12;
  const sz=(bw-gap*3)/4;
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    const v=grid[r][c];if(!v)continue;
    const el=document.createElement('div');
    el.className='tile';
    const[bg,fg]=tileColor(v);
    Object.assign(el.style,{
      width:sz+'px',height:sz+'px',top:(r*(sz+gap))+'px',left:(c*(sz+gap))+'px',
      background:bg,color:fg,fontSize:tileFontSize(v,sz)
    });
    el.textContent=v;
    tileEls.push({el,r,c,v});
    $board.appendChild(el);
  }
}

function markNew(){
  tileEls.forEach(t=>{if(t.isNew)t.el.classList.add('new')});
}
function markMerged(positions){
  tileEls.forEach(t=>{
    if(positions.some(p=>p[0]===t.r&&p[1]===t.c))t.el.classList.add('merged');
  });
}

function move(dir){
  save();
  let moved=false;const merged=[];
  const rows=dir==='up'||dir==='down';
  const rev=dir==='down'||dir==='right';
  for(let i=0;i<4;i++){
    let line=[];
    for(let j=0;j<4;j++){const r=rows?(rev?3-j:j):i,c=rows?i:(rev?3-j:j);line.push(grid[r][c])}
    line=line.filter(Boolean);
    const nl=[];
    for(let k=0;k<line.length;k++){
      if(k+1<line.length&&line[k]===line[k+1]){
        const val=line[k]*2;nl.push(val);score+=val;
        if(val===2048&&!won){won=true}
        const pos=rev?3-nl.length+1:nl.length-1;
        merged.push(rows?[pos,i]:[i,pos]);
        k++;
      }else nl.push(line[k]);
    }
    while(nl.length<4)nl.push(0);
    for(let j=0;j<4;j++){
      const idx=rev?3-j:j;
      const r=rows?idx:i,c=rows?i:idx;
      if(grid[r][c]!==nl[j])moved=true;
      grid[r][c]=nl[j];
    }
  }
  if(!moved){prevState=null;return}
  spawn();
  // find newly spawned tile position
  render();
  markMerged(merged);
  // mark new tiles
  tileEls.forEach(t=>{
    const wasInPrev=prevState&&prevState.grid[t.r][t.c];
    // simple: last spawned is the one not merged
    // just mark all for simplicity ‚Äî new anim on spawn
  });
  if(won&&!keepPlaying)$overWin.classList.add('show');
  else if(isGameOver())$overLose.classList.add('show');
}

function isGameOver(){
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    if(!grid[r][c])return false;
    if(c<3&&grid[r][c]===grid[r][c+1])return false;
    if(r<3&&grid[r][c]===grid[r+1][c])return false;
  }
  return true;
}

// Input
document.addEventListener('keydown',e=>{
  const map={ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right',
             w:'up',W:'up',s:'down',S:'down',a:'left',A:'left',d:'right',D:'right'};
  if(map[e.key]){e.preventDefault();move(map[e.key])}
});

let tx,ty;
$wrap.addEventListener('touchstart',e=>{const t=e.touches[0];tx=t.clientX;ty=t.clientY},{passive:true});
$wrap.addEventListener('touchend',e=>{
  const t=e.changedTouches[0],dx=t.clientX-tx,dy=t.clientY-ty;
  if(Math.abs(dx)<30&&Math.abs(dy)<30)return;
  if(Math.abs(dx)>Math.abs(dy))move(dx>0?'right':'left');
  else move(dy>0?'down':'up');
},{passive:true});

document.getElementById('btnNew').onclick=init;
document.getElementById('btnNewW').onclick=init;
document.getElementById('btnNewL').onclick=init;
document.getElementById('btnUndo').onclick=undo;
document.getElementById('btnKeep').onclick=()=>{keepPlaying=true;$overWin.classList.remove('show')};
document.getElementById('btnTheme').onclick=()=>{
  document.body.classList.toggle('light');
  document.getElementById('btnTheme').textContent=document.body.classList.contains('light')?'‚òÄÔ∏è':'üåô';
  render();
};

window.addEventListener('resize',render);
init();
})();
</script>
</body>
</html>