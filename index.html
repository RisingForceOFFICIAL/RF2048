<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>RF2048</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{overflow:hidden;position:fixed;width:100%;height:100%;touch-action:none}
:root{
  --accent:#0ea5e9;--accent2:#67e8f9;
  --bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;
  --text:#e5e5e5;--text2:#a3a3a3;
  --cell:#1e1e1e;--radius:12px;--gap:10px
}
.theme-light{--bg:#f5f5f5;--bg2:#e5e5e5;--bg3:#d4d4d4;--text:#171717;--text2:#525252;--cell:#ccc}
.theme-neon{--accent:#ff00ff;--accent2:#00ffff;--bg:#0a0014;--bg2:#140020;--bg3:#1e0030;--text:#fff;--text2:#c0c;--cell:#1a0028}
.theme-ocean{--accent:#00b4d8;--accent2:#90e0ef;--bg:#001220;--bg2:#001a2e;--bg3:#002842;--text:#caf0f8;--text2:#90e0ef;--cell:#002040}
.theme-sunset{--accent:#ff6b35;--accent2:#ffd166;--bg:#120800;--bg2:#1f0f00;--bg3:#2d1600;--text:#fff3e0;--text2:#ffb088;--cell:#261200}
.theme-forest{--accent:#4ade80;--accent2:#86efac;--bg:#001208;--bg2:#001f0e;--bg3:#002d14;--text:#dcfce7;--text2:#86efac;--cell:#00240f}
.theme-galaxy{--accent:#a855f7;--accent2:#e879f9;--bg:#08000f;--bg2:#10001a;--bg3:#180028;--text:#f3e8ff;--text2:#d8b4fe;--cell:#12001f}
.theme-retro{--accent:#facc15;--accent2:#fef08a;--bg:#0f0f0f;--bg2:#1a1a1a;--bg3:#262626;--text:#fafafa;--text2:#d4d4d8;--cell:#202020}

body{
  background:var(--bg);color:var(--text);
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100dvh;transition:background .3s,color .3s;
  -webkit-user-select:none;user-select:none
}

.game-container{display:flex;flex-direction:column;align-items:center;width:min(400px,92vw)}

.header{display:flex;align-items:center;justify-content:space-between;width:100%;margin-bottom:12px}
.logo{font-size:1.8rem;font-weight:900;letter-spacing:-1px}
.logo span{color:var(--accent)}
.scores{display:flex;gap:6px}
.score-box{background:var(--bg2);border-radius:8px;padding:6px 12px;text-align:center;min-width:60px}
.score-box .label{font-size:.55rem;color:var(--accent2);text-transform:uppercase;letter-spacing:1px}
.score-box .val{font-size:1.1rem;font-weight:700}

.toolbar{display:flex;align-items:center;justify-content:center;width:100%;margin-bottom:10px;gap:6px}
.btn{
  background:var(--bg2);color:var(--text);border:none;
  border-radius:8px;padding:8px 14px;font-size:.75rem;font-weight:600;
  cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:4px
}
.btn:hover{background:var(--accent);color:#fff}
.btn:active{transform:scale(.95)}
.btn-icon{padding:8px 10px;font-size:1rem}
.btn-hint{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.btn-hint:hover{filter:brightness(1.1)}

.board-wrap{
  position:relative;width:100%;aspect-ratio:1;
  background:var(--bg2);border-radius:var(--radius);
  padding:var(--gap);transition:background .3s
}
.board{display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr);gap:var(--gap);width:100%;height:100%}
.cell{background:var(--cell);border-radius:calc(var(--radius) - 2px)}
.tile-layer{position:absolute;top:var(--gap);left:var(--gap);right:var(--gap);bottom:var(--gap);pointer-events:none}
.tile{
  position:absolute;display:flex;align-items:center;justify-content:center;
  font-weight:800;border-radius:calc(var(--radius) - 2px);
  transition:top .12s ease-out,left .12s ease-out;will-change:top,left
}
.tile.pop{animation:pop .2s ease}
.tile.appear{animation:appear .2s ease}
.tile.high{animation:glow 2s ease-in-out infinite}
.tile.mega{animation:glow 1s ease-in-out infinite,rainbow 3s linear infinite}
.tile.hint{box-shadow:0 0 0 3px var(--accent),0 0 20px var(--accent)!important;z-index:10}

@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
@keyframes appear{0%{transform:scale(0)}100%{transform:scale(1)}}
@keyframes glow{0%,100%{box-shadow:0 0 15px var(--accent)}50%{box-shadow:0 0 30px var(--accent)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes rainbow{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

.board-wrap.shake{animation:shake .25s ease}
.particle{position:absolute;pointer-events:none;border-radius:50%;z-index:20}
.score-float{position:absolute;font-weight:900;font-size:1.3rem;color:var(--accent);text-shadow:0 0 8px var(--accent);pointer-events:none;z-index:25}
.combo{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;font-weight:900;color:var(--accent);text-shadow:0 0 15px var(--accent);pointer-events:none;z-index:15;opacity:0}
.combo.show{opacity:1;animation:pulse .4s ease}

.hint-arrow{position:absolute;font-size:2.5rem;color:var(--accent);text-shadow:0 0 15px var(--accent);pointer-events:none;z-index:30;animation:pulse 1s infinite}

.stats{display:flex;gap:16px;margin-top:10px;font-size:.7rem;color:var(--text2)}

.overlay{
  position:absolute;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);
  border-radius:var(--radius);display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:40;
  opacity:0;pointer-events:none;transition:opacity .3s
}
.overlay.show{opacity:1;pointer-events:auto}
.overlay h2{font-size:1.8rem;margin-bottom:10px;color:var(--accent)}
.overlay .sub{color:var(--text2);margin-bottom:14px;font-size:.9rem}
.overlay .btn{margin:4px;padding:10px 20px}

.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);
  display:flex;align-items:center;justify-content:center;z-index:100;
  opacity:0;pointer-events:none;transition:opacity .3s
}
.modal.show{opacity:1;pointer-events:auto}
.modal-box{background:var(--bg2);border-radius:14px;padding:20px;max-width:300px;width:90%;animation:fadeIn .3s ease}
.modal-box h3{margin-bottom:14px;text-align:center;color:var(--accent);font-size:1.1rem}

.settings-group{margin-bottom:16px}
.settings-label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--bg3)}
.settings-row:last-child{border:none}
.settings-row span{font-size:.85rem}
.toggle{width:44px;height:24px;background:var(--bg3);border-radius:12px;position:relative;cursor:pointer;transition:background .2s}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:left .2s}
.toggle.on::after{left:22px}

.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.theme-btn{
  padding:10px 6px;border-radius:6px;border:2px solid transparent;
  cursor:pointer;font-weight:600;font-size:.65rem;transition:all .15s;text-align:center
}
.theme-btn:hover{transform:scale(1.05)}
.theme-btn.active{border-color:var(--accent)}
.theme-btn[data-theme="default"]{background:#1a1a1a;color:#0ea5e9}
.theme-btn[data-theme="light"]{background:#e5e5e5;color:#0ea5e9}
.theme-btn[data-theme="neon"]{background:#1e0030;color:#ff00ff}
.theme-btn[data-theme="ocean"]{background:#002842;color:#00b4d8}
.theme-btn[data-theme="sunset"]{background:#2d1600;color:#ff6b35}
.theme-btn[data-theme="forest"]{background:#002d14;color:#4ade80}
.theme-btn[data-theme="galaxy"]{background:#180028;color:#a855f7}
.theme-btn[data-theme="retro"]{background:#262626;color:#facc15}

.modal-close{margin-top:14px;width:100%}
</style>
</head>
<body>
<div class="game-container">
  <div class="header">
    <div class="logo"><span>RF</span>2048</div>
    <div class="scores">
      <div class="score-box"><div class="label">Score</div><div class="val" id="score">0</div></div>
      <div class="score-box"><div class="label">Best</div><div class="val" id="best">0</div></div>
    </div>
  </div>
  
  <div class="toolbar">
    <button class="btn" id="btnNew">üîÑ New</button>
    <button class="btn" id="btnUndo">‚Ü© Undo</button>
    <button class="btn btn-hint" id="btnHint">üí° Hint</button>
    <button class="btn btn-icon" id="btnSettings" title="Settings">‚öôÔ∏è</button>
  </div>
  
  <div class="board-wrap" id="wrap">
    <div class="board" id="board"></div>
    <div class="tile-layer" id="tileLayer"></div>
    <div class="overlay" id="winOverlay"><h2>You Win! üéâ</h2><div><button class="btn" id="btnKeep">Keep Playing</button><button class="btn" id="btnNewW">New Game</button></div></div>
    <div class="overlay" id="loseOverlay"><h2>Game Over</h2><div class="sub">Score: <span id="finalScore">0</span></div><button class="btn" id="btnNewL">Try Again</button></div>
  </div>
  
  <div class="stats">
    <span>üéØ <span id="statMoves">0</span> moves</span>
    <span>‚è±Ô∏è <span id="statTime">0:00</span></span>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
  <div class="modal-box">
    <h3>‚öôÔ∏è Settings</h3>
    
    <div class="settings-group">
      <div class="settings-label">Options</div>
      <div class="settings-row"><span>üîä Sound</span><div class="toggle on" id="togSound"></div></div>
      <div class="settings-row"><span>‚ú® Effects</span><div class="toggle on" id="togEffects"></div></div>
    </div>
    
    <div class="settings-group">
      <div class="settings-label">Theme</div>
      <div class="theme-grid">
        <button class="theme-btn active" data-theme="default">‚ö°Dark</button>
        <button class="theme-btn" data-theme="light">‚òÄÔ∏èLight</button>
        <button class="theme-btn" data-theme="neon">üíúNeon</button>
        <button class="theme-btn" data-theme="ocean">üåäOcean</button>
        <button class="theme-btn" data-theme="sunset">üåÖSunset</button>
        <button class="theme-btn" data-theme="forest">üå≤Forest</button>
        <button class="theme-btn" data-theme="galaxy">üååGalaxy</button>
        <button class="theme-btn" data-theme="retro">üïπÔ∏èRetro</button>
      </div>
    </div>
    
    <button class="btn modal-close" id="closeSettings">Done</button>
  </div>
</div>

<script>
(()=>{
const THEMES={
  default:{2:['#f0e6d3','#6b5c4c'],4:['#f7cba0','#6b5c4c'],8:['#f59e42','#fff'],16:['#e74c3c','#fff'],32:['#c0392b','#fff'],64:['#9b59b6','#fff'],128:['#3498db','#fff'],256:['#1abc9c','#fff'],512:['#27ae60','#fff'],1024:['#f1c40f','#fff'],2048:['#e91e63','#fff'],4096:['#00bcd4','#fff'],8192:['#673ab7','#fff'],16384:['#ff5722','#fff'],32768:['#607d8b','#fff'],65536:['#795548','#fff'],131072:['#000','#fff']},
  light:{2:['#e8e0d6','#5c534a'],4:['#ffd9a0','#5c534a'],8:['#ffab40','#fff'],16:['#ff5252','#fff'],32:['#d32f2f','#fff'],64:['#aa00ff','#fff'],128:['#2979ff','#fff'],256:['#00bfa5','#fff'],512:['#00c853','#fff'],1024:['#ffd600','#333'],2048:['#f50057','#fff'],4096:['#00e5ff','#333'],8192:['#7c4dff','#fff'],16384:['#ff3d00','#fff'],32768:['#455a64','#fff'],65536:['#6d4c41','#fff'],131072:['#212121','#fff']},
  neon:{2:['#ff00ff','#fff'],4:['#00ffff','#000'],8:['#ffff00','#000'],16:['#ff0000','#fff'],32:['#00ff00','#000'],64:['#0000ff','#fff'],128:['#ff8800','#fff'],256:['#8800ff','#fff'],512:['#00ff88','#000'],1024:['#ff0088','#fff'],2048:['#88ff00','#000'],4096:['#0088ff','#fff'],8192:['#ff00aa','#fff'],16384:['#aaff00','#000'],32768:['#00aaff','#fff'],65536:['#ff5500','#fff'],131072:['#fff','#000']},
  ocean:{2:['#e0f7fa','#004d66'],4:['#80deea','#004d66'],8:['#26c6da','#fff'],16:['#00acc1','#fff'],32:['#00838f','#fff'],64:['#006978','#fff'],128:['#0097a7','#fff'],256:['#00796b','#fff'],512:['#004d40','#fff'],1024:['#1de9b6','#004d40'],2048:['#64ffda','#004d40'],4096:['#18ffff','#004d40'],8192:['#84ffff','#004d40'],16384:['#a7ffeb','#004d40'],32768:['#b2ebf2','#004d66'],65536:['#e0f2f1','#004d40'],131072:['#fff','#004d40']},
  sunset:{2:['#fff8e1','#4e342e'],4:['#ffe082','#4e342e'],8:['#ffc107','#fff'],16:['#ff9800','#fff'],32:['#ff5722','#fff'],64:['#f44336','#fff'],128:['#e91e63','#fff'],256:['#9c27b0','#fff'],512:['#673ab7','#fff'],1024:['#3f51b5','#fff'],2048:['#2196f3','#fff'],4096:['#03a9f4','#fff'],8192:['#00bcd4','#fff'],16384:['#009688','#fff'],32768:['#4caf50','#fff'],65536:['#8bc34a','#fff'],131072:['#cddc39','#333']},
  forest:{2:['#f1f8e9','#33691e'],4:['#dcedc8','#33691e'],8:['#aed581','#fff'],16:['#8bc34a','#fff'],32:['#689f38','#fff'],64:['#558b2f','#fff'],128:['#33691e','#fff'],256:['#827717','#fff'],512:['#9e9d24','#fff'],1024:['#c0ca33','#333'],2048:['#ffeb3b','#333'],4096:['#ffc107','#333'],8192:['#ff9800','#fff'],16384:['#ff5722','#fff'],32768:['#795548','#fff'],65536:['#607d8b','#fff'],131072:['#9e9e9e','#333']},
  galaxy:{2:['#ede7f6','#311b92'],4:['#d1c4e9','#311b92'],8:['#b39ddb','#fff'],16:['#9575cd','#fff'],32:['#7e57c2','#fff'],64:['#673ab7','#fff'],128:['#5e35b1','#fff'],256:['#512da8','#fff'],512:['#4527a0','#fff'],1024:['#311b92','#fff'],2048:['#e91e63','#fff'],4096:['#f44336','#fff'],8192:['#ff9800','#fff'],16384:['#ffeb3b','#311b92'],32768:['#4caf50','#fff'],65536:['#00bcd4','#fff'],131072:['#2196f3','#fff']},
  retro:{2:['#fff9c4','#5d4037'],4:['#fff176','#5d4037'],8:['#ffee58','#5d4037'],16:['#ffca28','#5d4037'],32:['#ffa726','#fff'],64:['#ff7043','#fff'],128:['#ec407a','#fff'],256:['#ab47bc','#fff'],512:['#7e57c2','#fff'],1024:['#5c6bc0','#fff'],2048:['#42a5f5','#fff'],4096:['#29b6f6','#fff'],8192:['#26c6da','#fff'],16384:['#26a69a','#fff'],32768:['#66bb6a','#fff'],65536:['#9ccc65','#333'],131072:['#d4e157','#333']}
};

let grid,score,best,prev,won,keepGoing,moves,startTime,timer;
let sound=true,effects=true,theme='default';

const $=id=>document.getElementById(id);
const $board=$('board'),$tiles=$('tileLayer'),$wrap=$('wrap');

function getColor(v){return (THEMES[theme]&&THEMES[theme][v])||['#0ea5e9','#fff']}
function fontSize(v,s){if(v<100)return s*.5;if(v<1000)return s*.4;if(v<10000)return s*.32;return s*.26}

// Create cells
for(let i=0;i<16;i++){const c=document.createElement('div');c.className='cell';$board.appendChild(c)}

// Audio
let ctx;
function beep(freq,dur,type='sine',vol=.1){
  if(!sound)return;
  if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)();
  if(ctx.state==='suspended')ctx.resume();
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type=type;o.frequency.value=freq;g.gain.value=vol;
  o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+dur);
}

function init(){
  grid=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
  score=0;won=false;keepGoing=false;prev=null;moves=0;
  best=+(localStorage.getItem('rf2048_best')||0);
  theme=localStorage.getItem('rf2048_theme')||'default';
  sound=localStorage.getItem('rf2048_sound')!=='false';
  effects=localStorage.getItem('rf2048_effects')!=='false';
  applyTheme(theme);
  updateToggles();
  $('winOverlay').classList.remove('show');$('loseOverlay').classList.remove('show');
  spawn();spawn();render();
  startTime=Date.now();clearInterval(timer);timer=setInterval(tick,1000);
  updateStats();
}

function tick(){const s=Math.floor((Date.now()-startTime)/1000);$('statTime').textContent=Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60)}
function updateStats(){$('statMoves').textContent=moves}
function save(){prev={g:grid.map(r=>[...r]),s:score,m:moves}}
function undo(){if(!prev)return;grid=prev.g;score=prev.s;moves=prev.m;prev=null;$('winOverlay').classList.remove('show');$('loseOverlay').classList.remove('show');render();updateStats()}

function spawn(){
  const e=[];for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(!grid[r][c])e.push([r,c]);
  if(!e.length)return null;
  const[r,c]=e[Math.random()*e.length|0];grid[r][c]=Math.random()<.9?2:4;return[r,c];
}

// Effects
let combo=0,lastMergeTime=0;
function spawnParticles(x,y,color,count=10){
  if(!effects)return;
  for(let i=0;i<count;i++){
    const p=document.createElement('div');p.className='particle';
    const angle=Math.random()*Math.PI*2,speed=40+Math.random()*60,size=3+Math.random()*5;
    p.style.cssText=`left:${x}px;top:${y}px;width:${size}px;height:${size}px;background:${color};`;
    $wrap.appendChild(p);
    let px=x,py=y,life=1;
    const vx=Math.cos(angle)*speed,vy=Math.sin(angle)*speed;
    const anim=()=>{life-=.04;if(life<=0){p.remove();return}px+=vx*.015;py+=vy*.015;p.style.cssText=`left:${px}px;top:${py}px;width:${size}px;height:${size}px;background:${color};opacity:${life};transform:scale(${life})`;requestAnimationFrame(anim)};
    requestAnimationFrame(anim);
  }
}
function spawnScoreFloat(x,y,pts){
  if(!effects)return;
  const el=document.createElement('div');el.className='score-float';el.textContent='+'+pts;el.style.cssText=`left:${x}px;top:${y}px;animation:scoreFloat .7s ease-out forwards`;
  $wrap.appendChild(el);setTimeout(()=>el.remove(),700);
}
function showCombo(n){if(!effects)return;let cb=$wrap.querySelector('.combo');if(!cb){cb=document.createElement('div');cb.className='combo';$wrap.appendChild(cb)}cb.textContent=n+'x!';cb.classList.add('show');setTimeout(()=>cb.classList.remove('show'),600)}
function screenShake(){if(!effects)return;$wrap.classList.add('shake');setTimeout(()=>$wrap.classList.remove('shake'),250)}

function render(merged=[],spawned=null){
  $('score').textContent=score.toLocaleString();
  if(score>best){best=score;localStorage.setItem('rf2048_best',best)}
  $('best').textContent=best.toLocaleString();
  $tiles.innerHTML='';
  const cells=$board.querySelectorAll('.cell');if(!cells.length)return;
  const rect0=cells[0].getBoundingClientRect(),wrapRect=$wrap.getBoundingClientRect();
  const cellSize=rect0.width,gap=cells[1]?cells[1].getBoundingClientRect().left-rect0.right:10;
  const offsetX=rect0.left-wrapRect.left,offsetY=rect0.top-wrapRect.top;
  
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    const v=grid[r][c];if(!v)continue;
    const tile=document.createElement('div');tile.className='tile';
    const isMerged=merged.some(p=>p[0]===r&&p[1]===c);
    if(isMerged){tile.classList.add('pop');const tx=offsetX+c*(cellSize+gap)+cellSize/2,ty=offsetY+r*(cellSize+gap)+cellSize/2;spawnParticles(tx,ty,getColor(v)[0],8)}
    if(spawned&&spawned[0]===r&&spawned[1]===c)tile.classList.add('appear');
    if(v>=128)tile.classList.add('high');if(v>=2048)tile.classList.add('mega');
    const[bg,fg]=getColor(v);
    tile.style.cssText=`top:${r*(cellSize+gap)}px;left:${c*(cellSize+gap)}px;width:${cellSize}px;height:${cellSize}px;background:${bg};color:${fg};font-size:${fontSize(v,cellSize)}px`;
    tile.textContent=v;$tiles.appendChild(tile);
  }
}

function move(dir){
  if($('winOverlay').classList.contains('show')||$('loseOverlay').classList.contains('show'))return;
  save();let moved=false;const merged=[];
  const vertical=dir==='up'||dir==='down',reverse=dir==='down'||dir==='right';
  for(let i=0;i<4;i++){
    let line=[];for(let j=0;j<4;j++){const r=vertical?(reverse?3-j:j):i,c=vertical?i:(reverse?3-j:j);line.push(grid[r][c])}
    line=line.filter(Boolean);const result=[];
    for(let k=0;k<line.length;k++){
      if(k+1<line.length&&line[k]===line[k+1]){const val=line[k]*2;result.push(val);score+=val;if(val===2048&&!won)won=true;const pos=reverse?3-result.length+1:result.length-1;merged.push(vertical?[pos,i]:[i,pos]);k++}
      else result.push(line[k]);
    }
    while(result.length<4)result.push(0);
    for(let j=0;j<4;j++){const idx=reverse?3-j:j,r=vertical?idx:i,c=vertical?i:idx;if(grid[r][c]!==result[j])moved=true;grid[r][c]=result[j]}
  }
  if(!moved){prev=null;return}
  moves++;const pts=merged.reduce((s,m)=>s+grid[m[0]][m[1]],0);
  const now=Date.now();if(merged.length){if(now-lastMergeTime<1000)combo++;else combo=1;lastMergeTime=now;if(combo>=3)showCombo(combo);if(pts>=64)screenShake()}
  beep(merged.length?400+combo*40:280,.05);
  const spawned=spawn();render(merged,spawned);
  if(pts>0&&merged.length){const cells=$board.querySelectorAll('.cell'),rect=cells[merged[0][0]*4+merged[0][1]].getBoundingClientRect(),wr=$wrap.getBoundingClientRect();spawnScoreFloat(rect.left-wr.left+rect.width/2-20,rect.top-wr.top,pts)}
  updateStats();
  if(won&&!keepGoing){$('winOverlay').classList.add('show');beep(523,.1);setTimeout(()=>beep(659,.1),100);setTimeout(()=>beep(784,.15),200)}
  else if(isOver()){$('loseOverlay').classList.add('show');$('finalScore').textContent=score.toLocaleString();beep(180,.3,'sawtooth');clearInterval(timer)}
}

function isOver(){for(let r=0;r<4;r++)for(let c=0;c<4;c++){if(!grid[r][c])return false;if(c<3&&grid[r][c]===grid[r][c+1])return false;if(r<3&&grid[r][c]===grid[r+1][c])return false}return true}

// Best move calculation
function simulate(g,dir){
  const grid=g.map(r=>[...r]);let sc=0,moved=false;
  const vertical=dir==='up'||dir==='down',reverse=dir==='down'||dir==='right';
  for(let i=0;i<4;i++){
    let line=[];for(let j=0;j<4;j++){const r=vertical?(reverse?3-j:j):i,c=vertical?i:(reverse?3-j:j);line.push(grid[r][c])}
    line=line.filter(Boolean);const result=[];
    for(let k=0;k<line.length;k++){if(k+1<line.length&&line[k]===line[k+1]){const val=line[k]*2;result.push(val);sc+=val;k++}else result.push(line[k])}
    while(result.length<4)result.push(0);
    for(let j=0;j<4;j++){const idx=reverse?3-j:j,r=vertical?idx:i,c=vertical?i:idx;if(grid[r][c]!==result[j])moved=true;grid[r][c]=result[j]}
  }
  return moved?{grid,score:sc,empty:grid.flat().filter(x=>!x).length,max:Math.max(...grid.flat()),mono:monoScore(grid)}:null;
}
function monoScore(g){let s=0;for(let r=0;r<4;r++)for(let c=0;c<3;c++){if(g[r][c]>=g[r][c+1])s++;if(g[c][r]>=g[c+1][r])s++}return s}
function getBestMove(){
  const dirs=['up','down','left','right'];
  let best=null,bestScore=-Infinity;
  for(const dir of dirs){
    const res=simulate(grid,dir);
    if(!res)continue;
    const sc=res.score*2+res.empty*10+res.mono*3+Math.log2(res.max+1)*5;
    if(sc>bestScore){bestScore=sc;best=dir}
  }
  return best;
}
function showHint(){
  const best=getBestMove();
  if(!best)return;
  const arrows={up:'‚¨ÜÔ∏è',down:'‚¨áÔ∏è',left:'‚¨ÖÔ∏è',right:'‚û°Ô∏è'};
  let hint=$wrap.querySelector('.hint-arrow');
  if(!hint){hint=document.createElement('div');hint.className='hint-arrow';$wrap.appendChild(hint)}
  hint.textContent=arrows[best];
  hint.style.cssText=`top:50%;left:50%;transform:translate(-50%,-50%)`;
  setTimeout(()=>hint.remove(),1500);
  beep(800,.05);
}

function applyTheme(t){document.body.className=t==='default'?'':'theme-'+t;theme=t;localStorage.setItem('rf2048_theme',t);document.querySelectorAll('.theme-btn').forEach(b=>b.classList.toggle('active',b.dataset.theme===t));render()}
function updateToggles(){$('togSound').classList.toggle('on',sound);$('togEffects').classList.toggle('on',effects)}

// Events
document.addEventListener('keydown',e=>{const map={ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right',w:'up',s:'down',a:'left',d:'right'};if(map[e.key]){e.preventDefault();move(map[e.key])}});
let tx,ty;$wrap.addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY},{passive:true});
$wrap.addEventListener('touchend',e=>{const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;if(Math.abs(dx)<30&&Math.abs(dy)<30)return;move(Math.abs(dx)>Math.abs(dy)?(dx>0?'right':'left'):(dy>0?'down':'up'))},{passive:true});

$('btnNew').onclick=$('btnNewW').onclick=$('btnNewL').onclick=init;
$('btnUndo').onclick=undo;
$('btnHint').onclick=showHint;
$('btnKeep').onclick=()=>{keepGoing=true;$('winOverlay').classList.remove('show')};
$('btnSettings').onclick=()=>$('settingsModal').classList.add('show');
$('closeSettings').onclick=()=>$('settingsModal').classList.remove('show');
$('settingsModal').onclick=e=>{if(e.target.id==='settingsModal')$('settingsModal').classList.remove('show')};
$('togSound').onclick=()=>{sound=!sound;localStorage.setItem('rf2048_sound',sound);updateToggles()};
$('togEffects').onclick=()=>{effects=!effects;localStorage.setItem('rf2048_effects',effects);updateToggles()};
document.querySelectorAll('.theme-btn').forEach(b=>b.onclick=()=>applyTheme(b.dataset.theme));
window.addEventListener('resize',()=>render());
init();
})();
</script>
</body>
</html>
