<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>RF2048</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --accent:#0ea5e9;--accent2:#67e8f9;
  --bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;
  --text:#e5e5e5;--text2:#a3a3a3;--cell:#262626;
  --glow:rgba(14,165,233,.4);--radius:14px
}
/* Themes */
.theme-light{--bg:#f5f5f5;--bg2:#e5e5e5;--bg3:#d4d4d4;--text:#171717;--text2:#525252;--cell:#ccc;--glow:rgba(14,165,233,.3)}
.theme-neon{--accent:#ff00ff;--accent2:#00ffff;--bg:#0d001a;--bg2:#1a0033;--bg3:#2d004d;--text:#fff;--text2:#c0c;--cell:#2d004d;--glow:rgba(255,0,255,.5)}
.theme-ocean{--accent:#00b4d8;--accent2:#90e0ef;--bg:#03045e;--bg2:#023e8a;--bg3:#0077b6;--text:#caf0f8;--text2:#90e0ef;--cell:#0077b6;--glow:rgba(0,180,216,.5)}
.theme-sunset{--accent:#ff6b35;--accent2:#ffd166;--bg:#1a0a00;--bg2:#331a00;--bg3:#4d2600;--text:#fff3e0;--text2:#ffb088;--cell:#4d2600;--glow:rgba(255,107,53,.5)}
.theme-forest{--accent:#4ade80;--accent2:#86efac;--bg:#052e16;--bg2:#14532d;--bg3:#166534;--text:#dcfce7;--text2:#86efac;--cell:#166534;--glow:rgba(74,222,128,.4)}
.theme-galaxy{--accent:#a855f7;--accent2:#e879f9;--bg:#0c0015;--bg2:#1e0033;--bg3:#2e0052;--text:#f3e8ff;--text2:#d8b4fe;--cell:#2e0052;--glow:rgba(168,85,247,.5)}
.theme-retro{--accent:#facc15;--accent2:#fef08a;--bg:#18181b;--bg2:#27272a;--bg3:#3f3f46;--text:#fafafa;--text2:#d4d4d8;--cell:#3f3f46;--glow:rgba(250,204,21,.4)}

body{
  background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100dvh;overflow:hidden;
  transition:background .4s,color .4s;
  -webkit-user-select:none;user-select:none
}
.header{display:flex;align-items:center;justify-content:space-between;width:min(480px,92vw);margin-bottom:12px}
.logo{font-size:2.4rem;font-weight:900;letter-spacing:-1px;text-shadow:0 0 20px var(--glow)}
.logo span{color:var(--accent)}
.scores{display:flex;gap:8px}
.score-box{
  background:linear-gradient(135deg,var(--bg3),var(--bg2));
  border:1px solid rgba(255,255,255,.1);
  border-radius:10px;padding:6px 16px;text-align:center;min-width:80px;
  box-shadow:0 4px 15px rgba(0,0,0,.3)
}
.score-box .label{font-size:.65rem;color:var(--accent2);text-transform:uppercase;letter-spacing:1px}
.score-box .val{font-size:1.3rem;font-weight:700}
.score-add{
  position:absolute;font-weight:700;color:var(--accent);font-size:1.1rem;
  pointer-events:none;animation:scoreFloat 1s ease-out forwards;z-index:20
}
@keyframes scoreFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-40px)}}

.controls{display:flex;align-items:center;justify-content:space-between;width:min(480px,92vw);margin-bottom:12px;gap:6px;flex-wrap:wrap}
.btn{
  background:linear-gradient(135deg,var(--bg3),var(--bg2));
  color:var(--text);border:1px solid rgba(255,255,255,.1);
  border-radius:10px;padding:10px 18px;font-size:.85rem;font-weight:600;
  cursor:pointer;transition:all .2s;
  box-shadow:0 4px 15px rgba(0,0,0,.2)
}
.btn:hover{background:var(--accent);color:#fff;transform:translateY(-2px);box-shadow:0 6px 20px var(--glow)}
.btn:active{transform:scale(.95) translateY(0)}
.btn-icon{padding:10px 12px;font-size:1.2rem}

.board-wrap{
  position:relative;width:min(480px,92vw);aspect-ratio:1;
  background:linear-gradient(135deg,var(--bg2),var(--bg3));
  border-radius:var(--radius);padding:min(12px,2.5vw);
  box-shadow:0 8px 40px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.1);
  transition:background .4s
}
.board{position:relative;width:100%;height:100%;display:grid;grid-template:repeat(4,1fr)/repeat(4,1fr);gap:min(12px,2.5vw)}
.cell{
  background:var(--cell);border-radius:var(--radius);
  box-shadow:inset 0 2px 4px rgba(0,0,0,.2);
  transition:background .3s
}
.tile{
  position:absolute;display:flex;align-items:center;justify-content:center;
  font-weight:800;border-radius:var(--radius);
  transition:top .12s ease-out,left .12s ease-out;
  z-index:2;box-shadow:0 4px 15px rgba(0,0,0,.3)
}
.tile.merged{animation:pop .25s cubic-bezier(.3,1.4,.6,1)}
.tile.new{animation:appear .25s cubic-bezier(.3,1.4,.6,1)}
.tile.high{box-shadow:0 0 25px var(--glow),0 4px 15px rgba(0,0,0,.3)}
@keyframes pop{0%{transform:scale(1)}40%{transform:scale(1.2)}100%{transform:scale(1)}}
@keyframes appear{0%{transform:scale(0);opacity:0}60%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}

.particles{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:5}
.particle{
  position:absolute;width:8px;height:8px;border-radius:50%;
  pointer-events:none;animation:particleFly .8s ease-out forwards
}
@keyframes particleFly{
  0%{opacity:1;transform:scale(1) translate(0,0)}
  100%{opacity:0;transform:scale(0) translate(var(--tx),var(--ty))}
}

.overlay{
  position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(0,0,0,.85),rgba(0,0,0,.75));
  backdrop-filter:blur(8px);
  border-radius:var(--radius);display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:10;
  opacity:0;pointer-events:none;transition:opacity .4s
}
.overlay.show{opacity:1;pointer-events:auto}
.overlay h2{font-size:2.2rem;margin-bottom:16px;text-shadow:0 0 30px var(--glow)}
.overlay .btn{margin-top:8px;font-size:1rem;padding:14px 32px}

/* Theme picker modal */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);
  display:flex;align-items:center;justify-content:center;z-index:100;
  opacity:0;pointer-events:none;transition:opacity .3s
}
.modal.show{opacity:1;pointer-events:auto}
.modal-content{
  background:linear-gradient(135deg,var(--bg2),var(--bg3));
  border:1px solid rgba(255,255,255,.1);
  border-radius:16px;padding:24px;max-width:340px;width:90%;
  box-shadow:0 20px 60px rgba(0,0,0,.5)
}
.modal h3{margin-bottom:16px;font-size:1.3rem;text-align:center;color:var(--accent)}
.theme-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.theme-btn{
  padding:14px;border-radius:10px;border:2px solid transparent;
  cursor:pointer;font-weight:600;font-size:.85rem;
  transition:all .2s;text-align:center
}
.theme-btn:hover{transform:scale(1.05)}
.theme-btn.active{border-color:var(--accent);box-shadow:0 0 15px var(--glow)}
.theme-btn[data-theme="default"]{background:linear-gradient(135deg,#1a1a1a,#0a0a0a);color:#0ea5e9}
.theme-btn[data-theme="light"]{background:linear-gradient(135deg,#f5f5f5,#e5e5e5);color:#0ea5e9}
.theme-btn[data-theme="neon"]{background:linear-gradient(135deg,#2d004d,#0d001a);color:#ff00ff}
.theme-btn[data-theme="ocean"]{background:linear-gradient(135deg,#0077b6,#03045e);color:#00b4d8}
.theme-btn[data-theme="sunset"]{background:linear-gradient(135deg,#4d2600,#1a0a00);color:#ff6b35}
.theme-btn[data-theme="forest"]{background:linear-gradient(135deg,#166534,#052e16);color:#4ade80}
.theme-btn[data-theme="galaxy"]{background:linear-gradient(135deg,#2e0052,#0c0015);color:#a855f7}
.theme-btn[data-theme="retro"]{background:linear-gradient(135deg,#3f3f46,#18181b);color:#facc15}
.close-modal{margin-top:16px;width:100%}

/* Confetti */
.confetti{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:50;overflow:hidden}
.confetti-piece{
  position:absolute;width:10px;height:20px;top:-20px;
  animation:confettiFall 3s linear forwards
}
@keyframes confettiFall{
  0%{transform:translateY(0) rotate(0deg);opacity:1}
  100%{transform:translateY(100vh) rotate(720deg);opacity:0}
}

/* Stats bar */
.stats{
  display:flex;gap:16px;margin-top:12px;font-size:.75rem;color:var(--text2);
  width:min(480px,92vw);justify-content:center
}
.stat{display:flex;align-items:center;gap:4px}
.stat-icon{font-size:1rem}
</style>
</head>
<body>
<div class="header">
  <div class="logo"><span>RF</span>2048</div>
  <div class="scores">
    <div class="score-box"><div class="label">Score</div><div class="val" id="score">0</div></div>
    <div class="score-box"><div class="label">Best</div><div class="val" id="best">0</div></div>
  </div>
</div>
<div class="controls">
  <button class="btn" id="btnNew">New Game</button>
  <button class="btn" id="btnUndo">‚Ü© Undo</button>
  <button class="btn btn-icon" id="btnTheme" title="Choose theme">üé®</button>
  <button class="btn btn-icon" id="btnSound" title="Toggle sound">üîä</button>
</div>
<div class="board-wrap" id="boardWrap">
  <div class="board" id="board"></div>
  <div class="particles" id="particles"></div>
  <div class="overlay" id="overWin"><h2 style="color:var(--accent)">You Win! üéâ</h2><button class="btn" id="btnKeep">Keep Playing</button><button class="btn" id="btnNewW">New Game</button></div>
  <div class="overlay" id="overLose"><h2>Game Over üíÄ</h2><p style="color:var(--text2);margin-bottom:12px">Final Score: <span id="finalScore">0</span></p><button class="btn" id="btnNewL">Try Again</button></div>
</div>
<div class="stats">
  <div class="stat"><span class="stat-icon">üéØ</span><span id="statMoves">0</span> moves</div>
  <div class="stat"><span class="stat-icon">‚è±Ô∏è</span><span id="statTime">0:00</span></div>
  <div class="stat"><span class="stat-icon">üèÜ</span><span id="statHighTile">0</span> max</div>
</div>

<!-- Theme Modal -->
<div class="modal" id="themeModal">
  <div class="modal-content">
    <h3>üé® Choose Theme</h3>
    <div class="theme-grid">
      <button class="theme-btn active" data-theme="default">‚ö° RF Dark</button>
      <button class="theme-btn" data-theme="light">‚òÄÔ∏è Light</button>
      <button class="theme-btn" data-theme="neon">üíú Neon</button>
      <button class="theme-btn" data-theme="ocean">üåä Ocean</button>
      <button class="theme-btn" data-theme="sunset">üåÖ Sunset</button>
      <button class="theme-btn" data-theme="forest">üå≤ Forest</button>
      <button class="theme-btn" data-theme="galaxy">üåå Galaxy</button>
      <button class="theme-btn" data-theme="retro">üïπÔ∏è Retro</button>
    </div>
    <button class="btn close-modal" id="closeTheme">Done</button>
  </div>
</div>

<div class="confetti" id="confetti"></div>

<script>
(function(){
// Theme-aware tile colors
const TILE_COLORS={
  2:['#eee4da','#776e65'],4:['#ede0c8','#776e65'],8:['#f2b179','#fff'],
  16:['#f59563','#fff'],32:['#f67c5f','#fff'],64:['#f65e3b','#fff'],
  128:['#edcf72','#fff'],256:['#edcc61','#fff'],512:['#edc850','#fff'],
  1024:['#edc53f','#fff'],2048:['#edc22e','#fff'],4096:['#3e3933','#fff'],
  8192:['#0ea5e9','#fff'],16384:['#67e8f9','#1a1a1a'],32768:['#a855f7','#fff'],65536:['#ec4899','#fff']
};
const THEMED_COLORS={
  neon:{2:['#ff00ff','#fff'],4:['#cc00cc','#fff'],8:['#00ffff','#000'],16:['#00cccc','#000'],32:['#ff00aa','#fff'],64:['#aa00ff','#fff'],128:['#00ff88','#000'],256:['#ff8800','#fff'],512:['#ff0088','#fff'],1024:['#8800ff','#fff'],2048:['#00ff00','#000']},
  ocean:{2:['#caf0f8','#03045e'],4:['#90e0ef','#03045e'],8:['#00b4d8','#fff'],16:['#0096c7','#fff'],32:['#0077b6','#fff'],64:['#023e8a','#fff'],128:['#48cae4','#03045e'],256:['#ade8f4','#03045e'],512:['#00b4d8','#fff'],1024:['#0096c7','#fff'],2048:['#03045e','#caf0f8']},
  sunset:{2:['#fff3e0','#4d2600'],4:['#ffb088','#4d2600'],8:['#ff6b35','#fff'],16:['#f7931e','#fff'],32:['#ffd166','#4d2600'],64:['#ef476f','#fff'],128:['#ff8c42','#fff'],256:['#ffd166','#4d2600'],512:['#ff6b35','#fff'],1024:['#f7931e','#fff'],2048:['#ef476f','#fff']},
  forest:{2:['#dcfce7','#052e16'],4:['#bbf7d0','#052e16'],8:['#4ade80','#fff'],16:['#22c55e','#fff'],32:['#16a34a','#fff'],64:['#15803d','#fff'],128:['#86efac','#052e16'],256:['#a7f3d0','#052e16'],512:['#34d399','#fff'],1024:['#10b981','#fff'],2048:['#059669','#fff']},
  galaxy:{2:['#f3e8ff','#0c0015'],4:['#e9d5ff','#0c0015'],8:['#a855f7','#fff'],16:['#9333ea','#fff'],32:['#7c3aed','#fff'],64:['#6d28d9','#fff'],128:['#c084fc','#fff'],256:['#e879f9','#0c0015'],512:['#a855f7','#fff'],1024:['#9333ea','#fff'],2048:['#581c87','#fff']},
  retro:{2:['#fef9c3','#18181b'],4:['#fef08a','#18181b'],8:['#facc15','#18181b'],16:['#eab308','#fff'],32:['#ca8a04','#fff'],64:['#a16207','#fff'],128:['#fde047','#18181b'],256:['#fef08a','#18181b'],512:['#facc15','#18181b'],1024:['#eab308','#fff'],2048:['#78350f','#fef08a']}
};
let currentTheme='default';
function tileColor(v){
  const themed=THEMED_COLORS[currentTheme];
  if(themed&&themed[v])return themed[v];
  return TILE_COLORS[v]||['var(--accent)','#fff'];
}
function tileFontSize(v,sz){
  if(v<100)return sz*.48+'px';if(v<1000)return sz*.38+'px';
  if(v<10000)return sz*.3+'px';return sz*.24+'px';
}

let grid,score,bestScore,prevState,won,keepPlaying,moves,startTime,timerInterval,soundOn=true;
const $board=document.getElementById('board'),
      $score=document.getElementById('score'),
      $best=document.getElementById('best'),
      $overWin=document.getElementById('overWin'),
      $overLose=document.getElementById('overLose'),
      $wrap=document.getElementById('boardWrap'),
      $particles=document.getElementById('particles'),
      $confetti=document.getElementById('confetti');

// Audio context for sounds
let audioCtx;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume()}
function playSound(type){
  if(!soundOn)return;initAudio();
  const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
  osc.connect(gain);gain.connect(audioCtx.destination);
  if(type==='move'){osc.frequency.value=300;gain.gain.value=.08;osc.start();osc.stop(audioCtx.currentTime+.05)}
  else if(type==='merge'){osc.frequency.value=520;gain.gain.value=.12;osc.start();osc.stop(audioCtx.currentTime+.1)}
  else if(type==='win'){
    osc.frequency.value=523;gain.gain.value=.15;osc.start();
    osc.frequency.setValueAtTime(659,audioCtx.currentTime+.15);
    osc.frequency.setValueAtTime(784,audioCtx.currentTime+.3);
    osc.stop(audioCtx.currentTime+.5);
  }
  else if(type==='lose'){osc.type='sawtooth';osc.frequency.value=200;gain.gain.value=.1;osc.start();osc.frequency.linearRampToValueAtTime(100,audioCtx.currentTime+.3);osc.stop(audioCtx.currentTime+.4)}
}

// Init cells
for(let i=0;i<16;i++){const c=document.createElement('div');c.className='cell';$board.appendChild(c)}

function init(){
  grid=Array.from({length:4},()=>[0,0,0,0]);
  score=0;won=false;keepPlaying=false;prevState=null;moves=0;
  $overWin.classList.remove('show');$overLose.classList.remove('show');
  bestScore=+(localStorage.getItem('rf2048best')||0);
  currentTheme=localStorage.getItem('rf2048theme')||'default';
  applyTheme(currentTheme);
  spawn();spawn();render();
  startTime=Date.now();
  clearInterval(timerInterval);
  timerInterval=setInterval(updateTimer,1000);
  updateStats();
}

function updateTimer(){
  const elapsed=Math.floor((Date.now()-startTime)/1000);
  const m=Math.floor(elapsed/60),s=elapsed%60;
  document.getElementById('statTime').textContent=m+':'+(s<10?'0':'')+s;
}
function updateStats(){
  document.getElementById('statMoves').textContent=moves;
  const max=Math.max(...grid.flat());
  document.getElementById('statHighTile').textContent=max||0;
}

function save(){prevState={grid:grid.map(r=>[...r]),score,moves}}
function undo(){
  if(!prevState)return;
  grid=prevState.grid;score=prevState.score;moves=prevState.moves;prevState=null;
  $overWin.classList.remove('show');$overLose.classList.remove('show');
  render();updateStats();
}

function spawn(){
  const empty=[];
  for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(!grid[r][c])empty.push([r,c]);
  if(!empty.length)return;
  const[r,c]=empty[Math.random()*empty.length|0];
  grid[r][c]=Math.random()<.9?2:4;
}

let tileEls=[];
function render(){
  $score.textContent=score.toLocaleString();
  if(score>bestScore){bestScore=score;localStorage.setItem('rf2048best',bestScore)}
  $best.textContent=bestScore.toLocaleString();
  // remove old tiles after animation
  const old=tileEls;setTimeout(()=>old.forEach(t=>t.el&&t.el.remove()),130);
  tileEls=[];
  const bw=$board.offsetWidth,gap=parseFloat(getComputedStyle($board).gap)||12;
  const sz=(bw-gap*3)/4;
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    const v=grid[r][c];if(!v)continue;
    const el=document.createElement('div');
    el.className='tile'+(v>=128?' high':'');
    const[bg,fg]=tileColor(v);
    const gradient=v>=8?`linear-gradient(135deg,${bg},${adjustColor(bg,-.1)})`:`linear-gradient(135deg,${bg},${adjustColor(bg,-.05)})`;
    Object.assign(el.style,{
      width:sz+'px',height:sz+'px',top:(r*(sz+gap))+'px',left:(c*(sz+gap))+'px',
      background:gradient,color:fg,fontSize:tileFontSize(v,sz)
    });
    el.textContent=v;
    tileEls.push({el,r,c,v});
    $board.appendChild(el);
  }
}

function adjustColor(hex,amt){
  let c=hex.replace('#','');if(c.length===3)c=c[0]+c[0]+c[1]+c[1]+c[2]+c[2];
  const num=parseInt(c,16);
  let r=(num>>16)+Math.round(255*amt),g=((num>>8)&0xff)+Math.round(255*amt),b=(num&0xff)+Math.round(255*amt);
  r=Math.max(0,Math.min(255,r));g=Math.max(0,Math.min(255,g));b=Math.max(0,Math.min(255,b));
  return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
}

function spawnParticles(r,c,color){
  const bw=$board.offsetWidth,gap=parseFloat(getComputedStyle($board).gap)||12,sz=(bw-gap*3)/4;
  const cx=c*(sz+gap)+sz/2,cy=r*(sz+gap)+sz/2;
  for(let i=0;i<8;i++){
    const p=document.createElement('div');p.className='particle';
    const angle=Math.random()*Math.PI*2,dist=40+Math.random()*30;
    p.style.cssText=`left:${cx}px;top:${cy}px;background:${color};--tx:${Math.cos(angle)*dist}px;--ty:${Math.sin(angle)*dist}px`;
    $particles.appendChild(p);
    setTimeout(()=>p.remove(),800);
  }
}

function showScoreAdd(pts,r,c){
  const bw=$board.offsetWidth,gap=parseFloat(getComputedStyle($board).gap)||12,sz=(bw-gap*3)/4;
  const el=document.createElement('div');el.className='score-add';
  el.textContent='+'+pts;
  el.style.left=(c*(sz+gap)+sz/2)+'px';el.style.top=(r*(sz+gap))+'px';
  $wrap.appendChild(el);
  setTimeout(()=>el.remove(),1000);
}

function markMerged(positions){
  tileEls.forEach(t=>{
    if(positions.some(p=>p[0]===t.r&&p[1]===t.c)){
      t.el.classList.add('merged');
      spawnParticles(t.r,t.c,tileColor(t.v)[0]);
    }
  });
}

function move(dir){
  if($overWin.classList.contains('show')||$overLose.classList.contains('show'))return;
  save();
  let moved=false;const merged=[];let pts=0;
  const rows=dir==='up'||dir==='down';
  const rev=dir==='down'||dir==='right';
  for(let i=0;i<4;i++){
    let line=[];
    for(let j=0;j<4;j++){const r=rows?(rev?3-j:j):i,c=rows?i:(rev?3-j:j);line.push(grid[r][c])}
    line=line.filter(Boolean);
    const nl=[];
    for(let k=0;k<line.length;k++){
      if(k+1<line.length&&line[k]===line[k+1]){
        const val=line[k]*2;nl.push(val);pts+=val;
        if(val===2048&&!won){won=true}
        const pos=rev?3-nl.length+1:nl.length-1;
        merged.push(rows?[pos,i]:[i,pos]);
        k++;
      }else nl.push(line[k]);
    }
    while(nl.length<4)nl.push(0);
    for(let j=0;j<4;j++){
      const idx=rev?3-j:j;
      const r=rows?idx:i,c=rows?i:idx;
      if(grid[r][c]!==nl[j])moved=true;
      grid[r][c]=nl[j];
    }
  }
  if(!moved){prevState=null;return}
  score+=pts;moves++;
  playSound(merged.length?'merge':'move');
  spawn();render();markMerged(merged);
  if(pts>0&&merged.length)showScoreAdd(pts,merged[0][0],merged[0][1]);
  updateStats();
  if(won&&!keepPlaying){$overWin.classList.add('show');playSound('win');spawnConfetti()}
  else if(isGameOver()){$overLose.classList.add('show');document.getElementById('finalScore').textContent=score.toLocaleString();playSound('lose');clearInterval(timerInterval)}
}

function isGameOver(){
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    if(!grid[r][c])return false;
    if(c<3&&grid[r][c]===grid[r][c+1])return false;
    if(r<3&&grid[r][c]===grid[r+1][c])return false;
  }
  clearInterval(timerInterval);
  return true;
}

function spawnConfetti(){
  const colors=['#ff0','#f0f','#0ff','#f00','#0f0','#00f','var(--accent)','var(--accent2)'];
  for(let i=0;i<60;i++){
    const p=document.createElement('div');p.className='confetti-piece';
    p.style.left=Math.random()*100+'%';
    p.style.background=colors[Math.floor(Math.random()*colors.length)];
    p.style.animationDelay=(Math.random()*2)+'s';
    p.style.animationDuration=(2+Math.random()*2)+'s';
    $confetti.appendChild(p);
    setTimeout(()=>p.remove(),5000);
  }
}

// Theme handling
function applyTheme(theme){
  document.body.className='';
  if(theme!=='default')document.body.classList.add('theme-'+theme);
  currentTheme=theme;
  localStorage.setItem('rf2048theme',theme);
  document.querySelectorAll('.theme-btn').forEach(b=>{
    b.classList.toggle('active',b.dataset.theme===theme);
  });
  render();
}
document.querySelectorAll('.theme-btn').forEach(btn=>{
  btn.onclick=()=>applyTheme(btn.dataset.theme);
});
document.getElementById('btnTheme').onclick=()=>document.getElementById('themeModal').classList.add('show');
document.getElementById('closeTheme').onclick=()=>document.getElementById('themeModal').classList.remove('show');
document.getElementById('themeModal').onclick=e=>{if(e.target.id==='themeModal')e.target.classList.remove('show')};

// Sound toggle
document.getElementById('btnSound').onclick=()=>{
  soundOn=!soundOn;
  document.getElementById('btnSound').textContent=soundOn?'üîä':'üîá';
};

// Input
document.addEventListener('keydown',e=>{
  const map={ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right',
             w:'up',W:'up',s:'down',S:'down',a:'left',A:'left',d:'right',D:'right'};
  if(map[e.key]){e.preventDefault();move(map[e.key])}
});

let tx,ty;
$wrap.addEventListener('touchstart',e=>{const t=e.touches[0];tx=t.clientX;ty=t.clientY},{passive:true});
$wrap.addEventListener('touchend',e=>{
  const t=e.changedTouches[0],dx=t.clientX-tx,dy=t.clientY-ty;
  if(Math.abs(dx)<30&&Math.abs(dy)<30)return;
  if(Math.abs(dx)>Math.abs(dy))move(dx>0?'right':'left');
  else move(dy>0?'down':'up');
},{passive:true});

document.getElementById('btnNew').onclick=init;
document.getElementById('btnNewW').onclick=init;
document.getElementById('btnNewL').onclick=init;
document.getElementById('btnUndo').onclick=undo;
document.getElementById('btnKeep').onclick=()=>{keepPlaying=true;$overWin.classList.remove('show')};

window.addEventListener('resize',render);
init();
})();
</script>
</body>
</html>
